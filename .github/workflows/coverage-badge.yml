name: Coverage Badge

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  coverage:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      GOTOOLCHAIN: auto
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run tests with coverage
        run: go test ./... -covermode=atomic -coverprofile=coverage.out

      - name: Create coverage badge
        run: |
          set -eo pipefail
          total=$(go tool cover -func=coverage.out | awk '/^total:/ {print substr($3, 1, length($3)-1)}')
          echo "Total coverage: ${total}%"
          pct=${total%.*}
          color="#4c1"
          if [ "$pct" -lt 60 ]; then
            color="#e05d44"
          elif [ "$pct" -lt 80 ]; then
            color="#dfb317"
          fi
          cat > coverage.svg <<EOF
<svg xmlns="http://www.w3.org/2000/svg" width="120" height="20" role="img" aria-label="coverage: ${total}%">
  <linearGradient id="s" x2="0" y2="100%">
    <stop offset="0" stop-color="#fff" stop-opacity=".7"/>
    <stop offset=".1" stop-opacity=".1"/>
  </linearGradient>
  <rect rx="3" width="120" height="20" fill="#555"/>
  <rect rx="3" x="60" width="60" height="20" fill="${color}"/>
  <rect rx="3" width="120" height="20" fill="url(#s)"/>
  <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
    <text x="30" y="14">coverage</text>
    <text x="90" y="14">${total}%</text>
  </g>
</svg>
EOF

      - name: Commit badge if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add coverage.svg
          if git diff --cached --quiet; then
            echo "No badge changes to commit."
            exit 0
          fi
          git commit -m "Update coverage badge"
          git push
